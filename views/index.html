<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Notification Service</title>
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
    <script type="text/javascript" src="./js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>
<body>NodeJS Notification System</h1>
<div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
        Select User
        <span class="caret"></span>
    </button>
    <ul id="users" class="dropdown-menu" aria-labelledby="dropdownMenu1"></ul>
</div>
<span class="subscription"></span>
<input id="field" type="text" style="width:350px;">
<input id="send" type="button" value="send">
<div id="content"></div>
</body>
<script>
    window.onload = function() {
        getUsers();
        var messages = [];
        var socket = io.connect();
        var field = document.getElementById("field");
        var sendButton = document.getElementById("send");
        var content = document.getElementById("content");

        socket.on('notification', function (data) {
            if(data.message) {
                messages.push(data.message);
                var html = '';
                for(var i=0; i<messages.length; i++) {
                    html += messages[i] + '<br />';
                }
                content.innerHTML = html;
            } else {
                console.log("There is a problem:", data);
            }
        });

        socket.on('neha', function(data) {
            console.info(data.message);
        });

        sendButton.onclick = function() {
            var text = field.value;
            socket.emit('send', { message: text });
        };

    };

    function getUsers() {
        $.ajax({url: '/users',
            success: function(users){
                console.info('users : ', users);
                createDropdownOptions(users);
            },
            error: function(err) {
                console.info('error : ', err);
            }
        });
    }

    function createDropdownOptions(arr) {
        var options = '';
        for(var i = 0; i < arr.length; i++) {
            options = options + '<li><a href="#" onclick="getSubscription(\'' + arr[i]._id + '\')">'+ arr[i].displayName +'</a></li>';
        }
        console.info(document.getElementById('users'));
        document.getElementById('users').innerHTML = options;
    }

    function getSubscription(userId) {
        console.info('here : ', userId);
        $.ajax({url: '/users/'+userId+ '/subscription',
            success: function(subscription){
                document.getElementsByClassName("subscription").innerHTML = 'User has subscribed to : '+ subscription;
            },
            error: function(err) {
                console.info('error : ', err);
            }
        });
    }
</script>
</html>